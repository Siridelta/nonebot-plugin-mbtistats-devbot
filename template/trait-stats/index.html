<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f3f4f6;
            font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif;
        }

        /* 增加高度以容纳4个图表 */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 40px;
            border-radius: 0px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 1000px;
            box-sizing: border-box;
            height: 1350px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            margin-top: 0;
        }

        .meta {
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .sep {
            width: 1px;
            height: 14px;
            background-color: #ccc;
            margin: 2px 14px 0px;
            display: inline-block;
        }

        .top-charts {
            display: flex;
            width: 100%;
            height: 400px;
        }

        .chart-item {
            width: 25%;
            height: 100%;
        }

        #trend-chart-container {
            width: 100%;
            height: 650px;
            margin-top: 20px;
        }
        
        #history-table-container {
            width: 100%;
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>

<body style="height: 100%; margin: 0">
    <div class="container">
        <h1>{{ title }}</h1>
        <div class="meta">
            {{ group_name }}
            <div class="sep"></div>
            {{ total_count }} 人
            <div class="sep"></div>
            <span id="timestamp"></span>
        </div>
        
        <div class="top-charts">
            <div id="chart-ei" class="chart-item"></div>
            <div id="chart-ns" class="chart-item"></div>
            <div id="chart-tf" class="chart-item"></div>
            <div id="chart-jp" class="chart-item"></div>
        </div>
        <div id="trend-chart-container"></div>
        <div id="history-table-container"></div>
    </div>

    <script type="text/javascript">
        const date = new Date();
        document.getElementById("timestamp").textContent = `
            ${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.toLocaleTimeString()}
        `;
        
        // Jinja2 数据注入
        // rawData 结构: 
        /*
        {
            "EI": {"E": 10, "I": 20, "X": 1},
            "SN": {"S": 15, "N": 15, "X": 1},
            "TF": {"T": 12, "F": 18, "X": 1},
            "JP": {"J": 14, "P": 16, "X": 1}
        }
        */
        const rawData = {{ data | tojson }};
        const historyData = {{ history_data | tojson }};

        // 4个维度的配置
        // 颜色灵感来自 16Personalities 风格，但为了可见性进行了调整
        const traitConfig = [
            {
                id: 'chart-ei',
                rawKey: 'EI',
                traits: ['I', 'E', 'X'], // 内向 (I) / 外向 (E)
                labels: ['I', 'E', '未知'],
            },
            {
                id: 'chart-ns',
                rawKey: 'SN',
                traits: ['N', 'S', 'X'], // 直觉 (N) / 实感 (S)
                labels: ['N', 'S', '未知'],
            },
            {
                id: 'chart-tf',
                rawKey: 'TF',
                traits: ['F', 'T', 'X'], // 情感 (F) / 思考 (T)
                labels: ['F', 'T', '未知'],
            },
            {
                id: 'chart-jp',
                rawKey: 'JP',
                traits: ['P', 'J', 'X'], // 展望 (P) / 计划 (J)
                labels: ['P', 'J', '未知'],
            }
        ];

        // 基于连贯的方案重新分配颜色
        traitConfig[0].colors = ['#EEAB7E', '#8EBBE6', '#ccc']; // I(橙色), E(蓝色)
        traitConfig[1].colors = ['#89D18B', '#FFD863', '#ccc']; // N(绿色), S(黄色)
        traitConfig[2].colors = ['#d4a5a5', '#9e9ac8', '#ccc']; // F(微红), T(微紫)
        traitConfig[3].colors = ['#80b1d3', '#fdb462', '#ccc']; // P(蓝色), J(橙色)
        
        // 初始化函数
        traitConfig.forEach(cfg => {
            initChart(cfg);
        });

        function initChart(cfg) {
            const dom = document.getElementById(cfg.id);
            if (!dom) return;
            
            const myChart = echarts.init(dom);
            
            const trait1 = cfg.traits[0]; // e.g. 'I'
            const trait2 = cfg.traits[1]; // e.g. 'E'
            const traitX = cfg.traits[2]; // e.g. 'X'

            const name1 = cfg.labels[0];
            const name2 = cfg.labels[1];
            const nameX = cfg.labels[2];
            
            const data1 = {count: rawData[cfg.rawKey][trait1] || 0};
            const data2 = {count: rawData[cfg.rawKey][trait2] || 0};
            const dataX = {count: rawData[cfg.rawKey][traitX] || 0};

            // 饼图数据
            const pieData = [
                { value: data1.count, name: name1, itemStyle: { color: cfg.colors[0] }, label: { color: '#333' } },
                { value: data2.count, name: name2, itemStyle: { color: cfg.colors[1] }, label: { color: '#333' } },
                { value: dataX.count, name: nameX, itemStyle: { color: cfg.colors[2] }, label: { color: '#333' } }
            ];

            // "未知"项为 0 时不显示
            if (dataX.count === 0) {
                pieData.pop();
            }
            
            const option = {
                title: {
                    text: cfg.rawKey,
                    left: 'center'
                },
                textStyle: {
                    fontFamily: 'Noto Sans SC, Microsoft YaHei, sans-serif'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                series: [
                    {
                        name: 'Distribution',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '55%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 4,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            position: 'outside',
                            formatter: function (params) {
                                const name = params.name;
                                const percent = params.percent >= 1 ? params.percent.toFixed(0)
                                    : params.percent >= 0.1 ? params.percent.toFixed(1)
                                        : params.percent.toFixed(2);
                                if (name === '未知') {
                                    return `{weakTitle|${name}}\n{sub|${percent}%}`;
                                } else {
                                    return `{title|${name}}\n{sub|${percent}%}`;
                                }
                            },
                            rich: {
                                title: {
                                    color: '#333',
                                    fontSize: 12,
                                    fontWeight: 'bold',
                                },
                                weakTitle: {
                                    color: '#333',
                                    fontSize: 12,
                                    fontWeight: 'normal',
                                },
                                sub: {
                                    color: '#666',
                                    fontSize: 10,
                                    fontWeight: 'normal',
                                }
                            }
                        },
                        labelLine: {
                            show: true,
                            length: 15,
                            length2: 10
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        data: pieData
                    }
                ]
            };
            
            myChart.setOption(option);
        }
        
        // 绘制历史趋势图（改为堆积柱状图）
        if (historyData && historyData.length > 1) {
            const trendDom = document.getElementById("trend-chart-container");
            const trendChart = echarts.init(trendDom);
            
            // 准备趋势图数据
            const dates = historyData.map(record => {
                const d = new Date(record.timestamp);
                return `${d.getMonth()+1}-${d.getDate()}`;
            });
            
            // 初始化各特质的数据数组
            const traitSeriesData = {};
            const traits = ['I', 'E', 'N', 'S', 'F', 'T', 'P', 'J', '未知'];
            traits.forEach(trait => {
                traitSeriesData[trait] = Array(historyData.length).fill(0);
            });
            
            // 填充数据 - 按时间点和维度计算各特质占比
            historyData.forEach((record, recordIndex) => {
                const dimensions = ['EI', 'SN', 'TF', 'JP'];
                
                dimensions.forEach(dim => {
                    const dimObj = record.data[dim];
                    if (!dimObj) return;
                    
                    const total = Object.values(dimObj).reduce((sum, val) => sum + val, 0);
                    if (total === 0) return;
                    
                    // 将每个特质的比例分配到对应数组
                    Object.entries(dimObj).forEach(([rawTrait, count]) => {
                        let trait;
                        if (rawTrait === 'X') {
                            trait = '未知';
                        } else {
                            trait = rawTrait;
                        }
                        
                        if (traitSeriesData[trait]) {
                            traitSeriesData[trait][recordIndex] += (count / total * 100);
                        }
                    });
                });
            });
            
            // 创建系列
            const series = [];
            const colorMap = {
                'I': '#EEAB7E', 'E': '#8EBBE6',
                'N': '#89D18B', 'S': '#FFD863',
                'F': '#d4a5a5', 'T': '#9e9ac8',
                'P': '#80b1d3', 'J': '#fdb462',
                '未知': '#ccc'
            };
            
            traits.forEach(trait => {
                // 只添加有数据的系列
                if (traitSeriesData[trait].some(val => val > 0)) {
                    series.push({
                        name: trait,
                        type: 'bar',
                        stack: '总量',
                        barGap: '0%',
                        data: traitSeriesData[trait].map(val => parseFloat(val.toFixed(1))),
                        itemStyle: { color: colorMap[trait] }
                    });
                }
            });
            
            const trendOption = {
                title: {
                    text: '历史趋势',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function (params) {
                        let result = params[0].axisValueLabel + '<br/>';
                        // 按系列值从大到小排序
                        params.sort((a, b) => b.value - a.value);
                        params.forEach(param => {
                            if (param.value > 0) {
                                result += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                                result += `${param.seriesName}: ${parseFloat(param.value).toFixed(1)}%<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    type: 'scroll',
                    bottom: 0,
                    data: traits.filter(trait => 
                        traitSeriesData[trait].some(val => val > 0)
                    ),
                    textStyle: {
                        fontSize: 10
                    },
                    itemWidth: 10,
                    itemHeight: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '25%', // 增加底部空间以容纳两行图例
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value} %'
                    }
                },
                series: series
            };
            
            trendChart.setOption(trendOption);
        }
    </script>
</body>

</html>