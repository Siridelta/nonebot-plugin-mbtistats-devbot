# MBTI 统计页面图表修复与优化计划

## 0. 准备工作：主动统计功能与后端改造（辅助任务）

> **状态**：已完成 (外部任务/辅助AI完成)

### 0.1 主动统计功能 (High Priority)
- **目标**：实现机器人主动定期统计群组成员 MBTI 分布，而非仅依赖用户指令触发。
- **意义**：减少“数据空窗期”，积累更连续、高质量的历史数据，为前端图表优化打下基础。
- **注意事项**：
  - 需考虑家庭服务器部署可能存在的掉线/维护情况，数据仍可能存在间断，因此前端的“连续段绘制”逻辑依然必要。

### 0.2 后端数据传递与前端调试环境改造
- **目标**：让前端能够处理全量历史数据，并优化本地调试体验。
- **具体任务**：
  - **后端修改**：
    - 修改数据接口，不再仅仅传递“每天最后一个时间点”，而是传递指定时间范围内的全量历史数据（或经过初步筛选但密度较高的数据）。
  - **逻辑抽离**：
    - 把原先后端 Python 的存档数据 -> 传递给前端的数据的转换逻辑抽离成数据转换函数；
    - 移除里面对数据的“每日最后一个时间点”的清洗逻辑。
  - **前端测试脚本 (`debug_frontend.py`) 改造**：
    - 引入数据转换函数。
    - 允许直接读取真实的后端存储 JSON 文件（`data/v1/cache-charts/.../mbti-stats.json` 等）。
    - 自动将原始数据转换为前端 `mock.json` 所需格式，避免手动构造测试数据的繁琐与不真实感。

---

## 1. 核心功能：前端多尺度历史趋势图开发

> **状态**：已完成 (本阶段核心任务)

> **核心逻辑**：前端接管数据降采样与渲染逻辑，引入 LTTB 算法与连续性识别，并具备可视化一个同时包含高密度区（呈现为连续段）与低密度区（离散数据）的时间序列的能力。

### 1.1 关键算法函数：`getIntervalRenderData`
- **功能**：计算指定时间范围内的渲染数据，包含降采样（LTTB）与连续性识别。
- **签名**：
  ```typescript
  function getIntervalRenderData<T>(
      data: T[], 
      start: number, // Unix timestamp (ms), inclusive
      end: number,   // Unix timestamp (ms), inclusive
      sampleResolution: number, // LTTB bucket size (ms)
      continuityResolution: number, // 连续性阈值 (ms)
      lttbReference: (item: T) => number[] // 提取用于计算三角形面积的数值向量 (16维或4维)
  ): RenderData<T>
  ```
- **核心逻辑**：
  1.  **数据过滤与锚点获取**：
      - 选取 `[start, end]` 范围内的数据。
      - **关键**：纳入 `start` 之前最近的一个点作为 **左锚点 (Left Anchor)**（如果存在）。
      - **关键**：纳入 `end` 之后最近的一个点作为 **右锚点 (Right Anchor)**（如果存在）。
      - 依靠 Echarts 的 `clip` 属性，在我们向数据里引入锚点之后进行图象裁剪，确保图象合理。
  2.  **连续段识别**：
      - 我们把原始数据呈现为多个“连续段”和其余多个离散点的组合；在渲染连续段时我们使用下面的 LTTB 降采样算法。
      - 在连续段识别时，如果相邻两点时间差 `<= continuityResolution`，视为连续。
      - 识别出 `ContinuousSeries`（连续段）和离散点。
      - 连续段必然包含一个左端点和右端点，它们中间可以有零个或多个中间点。
  2.  **LTTB 降采样 (多维适配)**：
      - 将连续段划分为多个 buckets（桶），桶宽为 `sampleResolution`，多余的时间量并入最后一个桶。
      - LTTB 算法的核心：在每个桶中选择一个点，使得由“前一个被选点”、“当前点”、“下一个桶的平均中心”组成的三角形**面积最大**。
      - **多维处理**：由于是 16 维（16人格）或 4 维（4色），计算面积时取各维度三角形面积绝对值之和（或最大值）作为评判标准，确保整体趋势特征保留。
  4.  **数据结构定义**：
      ```typescript
      type TimePoint<T> = { timestamp: number, data: T };
      type ContinuousSeries<T> = {
          type: 'continuous',
          start: TimePoint<T>,
          end: TimePoint<T>,
          series: TimePoint<T>[] // 中间点
      };
      // 返回数组，元素按时间排序，包含离散点和连续段对象
      type RenderData<T> = (TimePoint<T> | ContinuousSeries<T>)[];
      ```

### 1.2 图表展示逻辑：多尺度组合
根据数据的总时间跨度，动态决定展示哪些图表组合。

- **常量参考**：
  - 图表实际宽度：约 `900px`
  - 点大小：根据已有的样式经验，点大小定为 `6px`
  - 视觉连续阈值：暂定为 `12px` (当两个端点在视觉上间隔一个点直径时，两点的中心间距) -> 对应时间长度即为 `continuityResolution`
  - 采样分辨率：暂定为 `3px` (半个点直径) -> 对应时间长度即为 `sampleResolution` (取大于等于该值的最小 $2^n$ 整数)

- **展示规则**：
  1.  **只有 1 个时间点**：不展示历史趋势图。
  2.  **总跨度 < 7天**：
      - 展示：`全历史记录图` (Type16 + Type4)
      - 总跨度 < 7天的判据是精确时间
  3.  **7天 <= 总跨度 < 2个月**：
      - 依次展示：`一周趋势图`, `全历史记录图`
      - 总跨度 < 2个月的判据是起止点的日期数值（后面同理）
      - 一周趋势图的起止点，起点为一周前又一日后的日期的 0 点，终点为当前时刻的明日的 0 点
  4.  **2个月 <= 总跨度 < 2年**：
      - 依次展示：`一周趋势图`, `一月趋势图`, `全历史记录图`
      - 一月趋势图的起止点，起点为一个月前（日期相同）又一日后的日期的 0 点，终点为当前时刻的明日的 0 点
  5.  **总跨度 >= 2年**：
      - 依次展示：`一周趋势图`, `一月趋势图`, `一年趋势图`, `全历史记录图`
      - 一年趋势图的起止点，起点为一年前（日期相同）又一日后的日期的 0 点，终点为当前时刻的明日的 0 点

### 1.3 渲染样式与层级设计
利用 ECharts 的 `custom` 系列或多 `line` 系列组合实现。

#### 16人格趋势堆叠图 (Type16 Stacked)
- **层级 1**：**非连续区堆叠面积图 (Area - Low Alpha)**
  - 仅填充颜色，**不显示线**，**不显示点**。
  - 表现整体分布趋势。
  - 样式：`opacity: 0.6`。
  - 数据源：非连续区数据。
  - 加入 `null` 以分割各个非连续区。
- **层级 2**：**连续区堆叠面积图 (Area - High Alpha)**
  - 仅填充颜色，**不显示线**，**不显示点**。
  - 样式：`opacity: 0.8`。
  - 数据源：连续区数据。
  - 加入 `null` 以分割各个连续区。
- **层级 3**：**非连续区曲线 (Line - Low Alpha)**
  - 仅绘制线。
  - 样式：`width: 2`, `opacity: 0.5 (0x80)`。
  - 数据源：非连续区数据。
  - 加入 `null` 以分割各个非连续区。
- **层级 4**：**连续段曲线 (Line - High Alpha)**
  - 仅绘制线。
  - 样式：`width: 3`, `opacity: 1.0 (0xff)`。
  - 数据源：识别出的连续段 `ContinuousSeries`。
  - **Z-Index 控制**：确保下方 Series 的曲线覆盖上方 Series。因为是堆叠图，如果某 MBTI 数量为 0，它的曲线将与其下方 MBTI 的曲线重叠，显然应该优先显示下方的非零值的 MBTI 类别。如果有多个 MBTI 数量为 0，这个逻辑依然能保证下方第一个非零值的 MBTI 类别优先显示。
- **层级 5 (顶层)**：**数据点 (Symbol)**
  - 仅绘制点，不绘制线。
  - 样式：`emptyCircle`, `size: 6px`。
  - 数据源：连续段的**端点** + 非连续区的所有点。

#### 四色人格趋势图 (Type4 Line)
- **层级 1**：**非连续区曲线** (同上)
- **层级 2**：**连续段曲线** (同上)
- **层级 3**：**数据点** (同上)

---

## 2. 后续优化：数据结构迁移 (Long Term)

> **状态**：待定 (暂不阻碍当前开发)

- **目标**：修正数据记录逻辑，支持“重复观测”记录。
- **变动**：
  - 修改 `mbti-stats.json` 数据结构：时间戳字段改为 `timestamps: number[]` 数组。
  - 含义：数组内的所有时间点，观测到的 MBTI 数据均完全一致。
  - 目的：区分“无数据”和“数据未变化”。我们的数据是“有缺失的时间序列”，在这个背景下，多保留一个时间戳数据就是保留更多有效信息。
- **涉及**：
  - 后端存储逻辑修改。
  - 数据迁移逻辑 (Migration)，做成模块。
  - 前端适配新数据结构。
